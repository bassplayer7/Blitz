"use strict";define(["knockout","pubsub"],function(n,r){var e=0;return function(o){function t(){d.rounds.push(d.partialRound),d.partialRound=i(),r.publish("round.complete",d.rounds().length+1)}function u(n){return{id:n.id,round:n.lastRecordedRound(),score:n.score()}}function a(){var r,e=o.players();e.forEach(function(e){r=n.utils.arrayFirst(d.partialRound.players,function(n){return e.id===n.id}),r||(e.incrementRound(!0),d.partialRound.players.push(u(e)))}),t()}var d=this;this.game=o;var i=function(){return{players:[],lowestRound:0,topRound:0,playersOnCurrentRound:!0}};this.rounds=n.observableArray([]),this.notifier=n.observable(),this.partialRound=i(),this.currentRound=n.pureComputed(function(){return d.rounds().length+1}),this.calculateRound=function(r){return 0!==r.lastRecordedRound()&&(n.utils.arrayFirst(d.partialRound.players,function(n){return r.id===n.id})&&0!==d.partialRound.topRound&&a(),d.partialRound.players.push(u(r)),d.partialRound.players.forEach(function(n){n.round>=d.partialRound.topRound&&(d.partialRound.topRound=n.round),n.round<=d.partialRound.topRound&&(d.partialRound.lowestRound=n.round),d.partialRound.playersOnCurrentRound=!(n.round<d.partialRound.topRound)}),d.partialRound.players.length<o.players().length&&(d.partialRound.playersOnCurrentRound=!1),d.partialRound.playersOnCurrentRound&&0!==d.partialRound.topRound&&t(),void this.notifier.notifySubscribers())},this.isRoundFinished=function(){return d.partialRound.playersOnCurrentRound===!0},this.forceCompleteGame=function(){a()},this.canCompleteGame=n.pureComputed(function(){return d.notifier(),o.score.topScore()>o.score.gameEndScore()}),this.resetRounds=function(){var r=d.rounds().length+1,e=o.score.gameEndScore(),u=o.score.leadPlayerName(),a=o.score.topScore(),s=d.rounds();o.players().forEach(function(n){n.lastRecordedRound(0)}),t(),d.rounds.removeAll(),d.partialRound=i(),setTimeout(function(){ga("send","event","Rounds","Played","One Game",r),ga("send","event","Game","Played","Score to Win",e),ga("send","event","Players","Won","Lead Player",u),ga("send","event","Players","Top Score","Winning Score",a),ga("send","event","Game","Played","Info",n.toJSON(s))},100)},this.incrementRoundDuration=function(){setInterval(function(){e++},1e3)},r.subscribe("round.update",function(n,r){d.calculateRound(r)}),r.subscribe("perist.load",function(n,r){r.hasOwnProperty("rounds")&&d.rounds(r.rounds),d.incrementRoundDuration()}),r.subscribe("round.complete",function(){ga("send","event","Round","Duration",e),e=0}),r.subscribe("game.reset",this.resetRounds),r.subscribe("game.clear",this.resetRounds)}});